<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Context Guard — Magec — Self-hosted Multi-Agent AI Platform</title>
  <meta name="description" content="Define multiple AI agents, chain them into workflows, connect tools. Voice, Telegram, webhooks, cron. Your server, your rules.">
  <meta name="theme-color" content="#1c1917">
  <link rel="icon" type="image/svg+xml" href="/img/logo.svg">
  <link rel="stylesheet" href="/css/style.css">
  <meta property="og:title" content="Context Guard">
  <meta property="og:description" content="Define multiple AI agents, chain them into workflows, connect tools. Voice, Telegram, webhooks, cron. Your server, your rules.">
  <meta property="og:type" content="website">
</head>
<body>
  <nav class="nav scrolled">
  <div class="nav__inner">
    <a href="/" class="nav__logo">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="ng" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#f87171"/></linearGradient></defs>
        <circle cx="32" cy="32" r="26" fill="url(#ng)"/>
        <circle cx="20" cy="24" r="2" fill="white" opacity=".9"/><circle cx="26" cy="18" r="1.5" fill="white" opacity=".7"/>
        <circle cx="40" cy="22" r="1.8" fill="white" opacity=".8"/><circle cx="46" cy="30" r="1.2" fill="white" opacity=".6"/>
        <circle cx="38" cy="38" r="2" fill="white" opacity=".75"/><circle cx="24" cy="40" r="1.4" fill="white" opacity=".65"/>
      </svg>
      Magec
    </a>
    <button class="nav__toggle" aria-label="Toggle menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <ul class="nav__links">
      
      <li><a href="/#how-it-works" class="nav__link">How it works</a></li>
      
      <li><a href="/#what" class="nav__link">Platform</a></li>
      
      <li><a href="/#use-cases" class="nav__link">Use cases</a></li>
      
      <li><a href="/#screenshots" class="nav__link">Screenshots</a></li>
      
      <li><a href="/docs/" class="nav__link">Docs</a></li>
      
      <li>
        <a href="https://github.com/achetronic/magec" class="nav__cta" target="_blank" rel="noopener">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
          GitHub
        </a>
      </li>
    </ul>
  </div>
</nav>

  <main>
    
<div class="container">
  <div class="docs-layout">
    <aside class="docs-sidebar">
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Getting Started</div>
        
        <a href="/docs/install-docker/" class="docs-sidebar__link">Docker Quick Start</a>
        
        <a href="/docs/install-compose-local/" class="docs-sidebar__link">Docker Compose</a>
        
        <a href="/docs/install-binary/" class="docs-sidebar__link">Binary Install</a>
        
        <a href="/docs/configuration/" class="docs-sidebar__link">Configuration</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Security</div>
        
        <a href="/docs/admin-password/" class="docs-sidebar__link">Admin Password</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Core Concepts</div>
        
        <a href="/docs/agents/" class="docs-sidebar__link">Agents</a>
        
        <a href="/docs/flows/" class="docs-sidebar__link">Agentic Flows</a>
        
        <a href="/docs/backends/" class="docs-sidebar__link">AI Backends</a>
        
        <a href="/docs/memory/" class="docs-sidebar__link">Memory</a>
        
        <a href="/docs/mcp/" class="docs-sidebar__link">MCP Tools</a>
        
        <a href="/docs/skills/" class="docs-sidebar__link">Skills</a>
        
        <a href="/docs/secrets/" class="docs-sidebar__link">Secrets</a>
        
        <a href="/docs/commands/" class="docs-sidebar__link">Commands</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Clients</div>
        
        <a href="/docs/clients/" class="docs-sidebar__link">Overview</a>
        
        <a href="/docs/voice-ui/" class="docs-sidebar__link">Voice UI</a>
        
        <a href="/docs/telegram/" class="docs-sidebar__link">Telegram</a>
        
        <a href="/docs/slack/" class="docs-sidebar__link">Slack</a>
        
        <a href="/docs/webhooks/" class="docs-sidebar__link">Webhooks</a>
        
        <a href="/docs/cron/" class="docs-sidebar__link">Cron</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Reference</div>
        
        <a href="/docs/api/" class="docs-sidebar__link">API Reference</a>
        
        <a href="/docs/voice-system/" class="docs-sidebar__link">Voice System</a>
        
        <a href="/docs/secrets-advanced/" class="docs-sidebar__link">Advanced Secrets</a>
        
        <a href="/docs/skills-vs-agents/" class="docs-sidebar__link">Skills vs. Agents</a>
        
        <a href="/docs/screenshots/" class="docs-sidebar__link">Screenshots</a>
        
      </div>
      
      
    </aside>
    <div class="docs-content">
      <button class="docs-sidebar-toggle btn btn--ghost">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        Navigation
      </button>
      <h1>Context Guard <span class="docs-badge">Experimental</span></h1>
      


<div class="docs-callout">
  Context Guard is <strong>experimental</strong>. It works and has been tested with real conversations, but there are edge cases not fully covered yet. Read <a href="#limitations">Limitations</a> for details.
</div>

<p>AI models can only handle a certain amount of text at once. This is called the <strong>context window</strong> — think of it as the model&rsquo;s short-term memory. The longer a conversation gets, the more of that memory it uses up. When it fills up, the conversation breaks.</p>
<p>Context Guard keeps that from happening. It watches the conversation size and, when things start getting tight, compresses the older messages into a short summary. The recent messages stay exactly as they are. The agent doesn&rsquo;t lose track of anything — the conversation just takes up less space.</p>
<p><strong>Without Context Guard</strong>, long conversations eventually fail. <strong>With it</strong>, they can go on as long as you need.</p>
<h2 id="how-it-works">How it works</h2>
<p>Before every message is sent to the model, Context Guard checks the conversation:</p>
<ol>
<li><strong>Is it getting too long?</strong> — It checks either the token count or the number of messages, depending on which strategy you chose.</li>
<li><strong>No</strong> — Nothing happens. Everything goes through normally.</li>
<li><strong>Yes</strong> — It splits the conversation in two: the <strong>old stuff</strong> and the <strong>recent stuff</strong>.</li>
<li>It asks the agent&rsquo;s own model to write a summary of the old stuff.</li>
<li>It swaps out all those old messages for the summary.</li>
<li>The model now sees: <code>[summary of earlier conversation] + [recent messages in full]</code>.</li>
</ol>
<p>The summary is saved between messages, so it doesn&rsquo;t disappear. Each time Context Guard runs again, it folds the previous summary into the new one. Nothing is forgotten — it just gets more compact over time.</p>
<p>If anything goes wrong during summarization (model error, timeout, empty response), Context Guard steps aside and lets the original conversation through. It never blocks anything.</p>
<h2 id="strategies">Strategies</h2>
<p>Two options. You pick one per agent.</p>
<h3 id="token-threshold">Token threshold</h3>
<p><strong>Recommended for most agents.</strong> It estimates how many tokens the conversation is using and only compresses when it&rsquo;s running out of room.</p>
<p>How much room it keeps:</p>
<ul>
<li><strong>Models with big context windows (over 200k tokens):</strong> Keeps 20,000 tokens free.</li>
<li><strong>Smaller models:</strong> Keeps 20% of the window free.</li>
</ul>
<p>When the conversation eats into that reserved space, Context Guard kicks in. It keeps the most recent 20% of the conversation intact and summarizes everything before that.</p>
<p>This is the best choice when the agent uses tools, does complex work, or when you want to get the most out of the model before compressing anything.</p>
<h3 id="sliding-window">Sliding window</h3>
<p>Simpler. It counts messages. When there are more than <code>maxTurns</code> messages, everything except the last <code>maxTurns</code> gets summarized.</p>
<p>It doesn&rsquo;t look at token counts at all — just the number of messages.</p>
<p>Good for chatbots, Q&amp;A agents, or any case where old messages stop being useful quickly.</p>



<div class="docs-callout docs-callout--info">
  <strong>Heads up if the agent uses tools.</strong> Tool calls add hidden messages — the model&rsquo;s request to call the tool and the tool&rsquo;s response each count as separate messages. One question where the agent calls a tool creates 4 messages, not 2. With <code>maxTurns: 20</code>, that&rsquo;s only about 5 tool-using exchanges before summarization fires. If the agent uses tools a lot, set a higher value (40–80) or just use token threshold instead.
</div>

<h2 id="setup">Setup</h2>
<p>Open an agent in the Admin UI, expand the <strong>LLM</strong> section, and turn on <strong>Context Guard</strong>.</p>
<table>
  <thead>
      <tr>
          <th>Setting</th>
          <th>What it does</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Enabled</td>
          <td>Turns Context Guard on or off</td>
      </tr>
      <tr>
          <td>Strategy</td>
          <td><code>Token threshold</code> (default) or <code>Sliding window</code></td>
      </tr>
      <tr>
          <td>Max turns</td>
          <td>Sliding window only — how many messages to keep. Default: <code>20</code></td>
      </tr>
  </tbody>
</table>
<p>If it&rsquo;s off, nothing changes for the agent. Zero overhead.</p>
<h3 id="which-strategy-to-pick">Which strategy to pick</h3>
<table>
  <thead>
      <tr>
          <th>Agent type</th>
          <th>Strategy</th>
          <th>Why</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Agent with tools</td>
          <td>Token threshold</td>
          <td>Uses the full context window, only compresses when needed</td>
      </tr>
      <tr>
          <td>Simple chatbot</td>
          <td>Sliding window, <code>maxTurns: 30</code></td>
          <td>Keeps things light, old messages rarely matter</td>
      </tr>
      <tr>
          <td>Long multi-step tasks</td>
          <td>Token threshold</td>
          <td>Needs all the context it can get to track progress</td>
      </tr>
  </tbody>
</table>
<h2 id="what-goes-into-the-summary">What goes into the summary</h2>
<p>Context Guard asks the agent&rsquo;s own model to write a summary with four sections:</p>
<ul>
<li><strong>Current State</strong> — What&rsquo;s being worked on, what&rsquo;s done, what&rsquo;s next</li>
<li><strong>Key Information</strong> — Names, dates, numbers, URLs, preferences, specifics</li>
<li><strong>Context &amp; Decisions</strong> — What was decided and why, what was tried and dropped</li>
<li><strong>Exact Next Steps</strong> — What to do next, specifically, not just &ldquo;keep going&rdquo;</li>
</ul>
<p>The idea: someone reading only this summary should be able to continue the conversation without asking &ldquo;what were we talking about?&rdquo;</p>
<p>Summaries are longer for models with big context windows and shorter for smaller models. There&rsquo;s both a soft limit (in the prompt) and a hard limit (on the API) to make sure the summary itself doesn&rsquo;t take up too much space.</p>
<p>If the model returns nothing (rare), Context Guard falls back to grabbing the first 200 characters of each message. Not pretty, but it keeps things moving.</p>
<h2 id="limitations">Limitations</h2>
<h3 id="tool-responses-disappear-from-summaries">Tool responses disappear from summaries</h3>
<p>When old messages get summarized, tool calls show up as just <code>[tool X returned a result]</code>. The actual data the tool returned — files, search results, API responses — is not included in the summary prompt.</p>
<p>The agent&rsquo;s conclusions based on that data will still be in the conversation, but the raw data itself is gone. This is how Google&rsquo;s <a href="https://github.com/google/adk-python">ADK Python</a> handles it too.</p>
<h3 id="huge-tool-responses-can-cause-trouble">Huge tool responses can cause trouble</h3>
<p>If a tool dumps a massive response into the conversation (100k+ tokens), that whole blob is sitting in the message history. Context Guard will catch it on the <em>next</em> message and compress, but the current message already has the giant response in it.</p>
<p>With the token threshold strategy this usually isn&rsquo;t a problem — the safety buffer absorbs it. But if a single tool response is bigger than the whole buffer, the model might reject the request before Context Guard can do anything about it.</p>
<p><strong>How to avoid this:</strong> Don&rsquo;t let your tools return unlimited data. Limit results, paginate, or return a reference instead of the full content. <a href="https://github.com/charmbracelet/crush">Claude Code</a> caps every tool — bash output at 30k characters, file reads at 5MB, search at 100 results. Follow that pattern.</p>
<h3 id="no-retry-after-a-failure">No retry after a failure</h3>
<p>If the conversation is already too big and the model says &ldquo;too many tokens,&rdquo; the request fails. Context Guard works <em>before</em> the call to keep this from happening, but it can&rsquo;t fix things <em>after</em> the fact.</p>
<p>Automatic retry (compress and try again) may come in a future version, but it depends on a feature in ADK that hasn&rsquo;t been released yet.</p>
<h3 id="token-counting-is-approximate">Token counting is approximate</h3>
<p>Tokens are estimated as <strong>4 characters ≈ 1 token</strong>. Same method Google&rsquo;s ADK uses. Works well for English, but can be off for CJK languages (underestimates) or code (overestimates).</p>
<h3 id="sliding-window-ignores-message-size">Sliding window ignores message size</h3>
<p>Sliding window counts messages, not their size. A message with 50,000 tokens counts the same as one with 10. If your conversations have wildly different message sizes, use token threshold instead.</p>
<h2 id="how-it-knows-the-models-limits">How it knows the model&rsquo;s limits</h2>
<p>Context Guard needs each model&rsquo;s context window size to know when to compress. It loads this from a model catalog that refreshes every 6 hours.</p>
<p>If a model isn&rsquo;t in the catalog, it assumes 128,000 tokens — safe enough for most current models.</p>

    </div>
  </div>
</div>

  </main>
  <div id="lightbox" class="lightbox">
  <button class="lightbox__close" aria-label="Close">✕</button>
  <img id="lightbox-img" src="" alt="">
</div>

  <footer class="footer">
  <div class="container">
    <div class="footer__inner">
      <div class="footer__brand">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
          <defs><linearGradient id="fg" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#f87171"/></linearGradient></defs>
          <circle cx="32" cy="32" r="26" fill="url(#fg)"/>
          <circle cx="20" cy="24" r="2" fill="white" opacity=".9"/><circle cx="40" cy="22" r="1.8" fill="white" opacity=".8"/>
          <circle cx="38" cy="38" r="2" fill="white" opacity=".75"/>
        </svg>
        Magec · Apache 2.0
      </div>
      <ul class="footer__links">
        <li><a href="https://github.com/achetronic/magec" target="_blank" rel="noopener">GitHub</a></li>
        <li><a href="/docs/">Docs</a></li>
        <li><a href="https://github.com/achetronic/magec/issues" target="_blank" rel="noopener">Issues</a></li>
      </ul>
    </div>
  </div>
</footer>

  <script type="module" src="/js/main.js"></script>
</body>
</html>
