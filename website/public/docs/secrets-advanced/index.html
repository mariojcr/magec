<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced Secrets — Magec — Self-hosted Multi-Agent AI Platform</title>
  <meta name="description" content="Define multiple AI agents, chain them into workflows, connect tools. Voice, Telegram, webhooks, cron. Your server, your rules.">
  <meta name="theme-color" content="#1c1917">
  <link rel="icon" type="image/svg+xml" href="/img/logo.svg">
  <link rel="stylesheet" href="/css/style.css">
  <meta property="og:title" content="Advanced Secrets">
  <meta property="og:description" content="Define multiple AI agents, chain them into workflows, connect tools. Voice, Telegram, webhooks, cron. Your server, your rules.">
  <meta property="og:type" content="website">
</head>
<body>
  <nav class="nav scrolled">
  <div class="nav__inner">
    <a href="/" class="nav__logo">
      <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
        <defs><linearGradient id="ng" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#f87171"/></linearGradient></defs>
        <circle cx="32" cy="32" r="26" fill="url(#ng)"/>
        <circle cx="20" cy="24" r="2" fill="white" opacity=".9"/><circle cx="26" cy="18" r="1.5" fill="white" opacity=".7"/>
        <circle cx="40" cy="22" r="1.8" fill="white" opacity=".8"/><circle cx="46" cy="30" r="1.2" fill="white" opacity=".6"/>
        <circle cx="38" cy="38" r="2" fill="white" opacity=".75"/><circle cx="24" cy="40" r="1.4" fill="white" opacity=".65"/>
      </svg>
      Magec
    </a>
    <button class="nav__toggle" aria-label="Toggle menu">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
    </button>
    <ul class="nav__links">
      
      <li><a href="/#how-it-works" class="nav__link">How it works</a></li>
      
      <li><a href="/#what" class="nav__link">Platform</a></li>
      
      <li><a href="/#use-cases" class="nav__link">Use cases</a></li>
      
      <li><a href="/#screenshots" class="nav__link">Screenshots</a></li>
      
      <li><a href="/docs/" class="nav__link">Docs</a></li>
      
      <li>
        <a href="https://github.com/achetronic/magec" class="nav__cta" target="_blank" rel="noopener">
          <svg viewBox="0 0 16 16" fill="currentColor"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"/></svg>
          GitHub
        </a>
      </li>
    </ul>
  </div>
</nav>

  <main>
    
<div class="container">
  <div class="docs-layout">
    <aside class="docs-sidebar">
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Getting Started</div>
        
        <a href="/docs/install-docker/" class="docs-sidebar__link">Docker Quick Start</a>
        
        <a href="/docs/install-compose-local/" class="docs-sidebar__link">Docker Compose</a>
        
        <a href="/docs/install-binary/" class="docs-sidebar__link">Binary Install</a>
        
        <a href="/docs/configuration/" class="docs-sidebar__link">Configuration</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Security</div>
        
        <a href="/docs/admin-password/" class="docs-sidebar__link">Admin Password</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Core Concepts</div>
        
        <a href="/docs/agents/" class="docs-sidebar__link">Agents</a>
        
        <a href="/docs/flows/" class="docs-sidebar__link">Agentic Flows</a>
        
        <a href="/docs/backends/" class="docs-sidebar__link">AI Backends</a>
        
        <a href="/docs/memory/" class="docs-sidebar__link">Memory</a>
        
        <a href="/docs/mcp/" class="docs-sidebar__link">MCP Tools</a>
        
        <a href="/docs/skills/" class="docs-sidebar__link">Skills</a>
        
        <a href="/docs/a2a/" class="docs-sidebar__link">A2A Protocol</a>
        
        <a href="/docs/secrets/" class="docs-sidebar__link">Secrets</a>
        
        <a href="/docs/commands/" class="docs-sidebar__link">Commands</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Clients</div>
        
        <a href="/docs/clients/" class="docs-sidebar__link">Overview</a>
        
        <a href="/docs/voice-ui/" class="docs-sidebar__link">Voice UI</a>
        
        <a href="/docs/telegram/" class="docs-sidebar__link">Telegram</a>
        
        <a href="/docs/slack/" class="docs-sidebar__link">Slack</a>
        
        <a href="/docs/webhooks/" class="docs-sidebar__link">Webhooks</a>
        
        <a href="/docs/cron/" class="docs-sidebar__link">Cron</a>
        
      </div>
      
      
      
      <div class="docs-sidebar__group">
        <div class="docs-sidebar__label">Reference</div>
        
        <a href="/docs/api/" class="docs-sidebar__link">API Reference</a>
        
        <a href="/docs/voice-system/" class="docs-sidebar__link">Voice System</a>
        
        <a href="/docs/secrets-advanced/" class="docs-sidebar__link docs-sidebar__link--active">Advanced Secrets</a>
        
        <a href="/docs/skills-vs-agents/" class="docs-sidebar__link">Skills vs. Agents</a>
        
        <a href="/docs/screenshots/" class="docs-sidebar__link">Screenshots</a>
        
      </div>
      
      
    </aside>
    <div class="docs-content">
      <button class="docs-sidebar-toggle btn btn--ghost">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
        Navigation
      </button>
      <h1>Advanced Secrets</h1>
      <p>This page covers the internal details of how Magec handles secrets — the expansion pipeline, encryption at rest, compatibility with external environment variables, and recovery procedures. For a practical guide on creating and using secrets, see <a href="/docs/secrets/">Secrets</a>.</p>
<p>Secrets are named values — API keys, tokens, passwords — that you manage through the Admin UI and reference anywhere in your configuration using <code>${KEY}</code> syntax. They provide a single place to store sensitive data instead of scattering environment variables across your deployment.</p>
<h2 id="how-secrets-work">How secrets work</h2>
<p>Each secret has a <strong>key</strong> (like <code>OPENAI_API_KEY</code>) and a <strong>value</strong> (the actual API key). When Magec starts, it loads all secrets and injects them as environment variables. Any <code>${VAR}</code> reference in <code>config.yaml</code> or <code>store.json</code> that matches a secret key gets expanded to its value.</p>
<p>This means a backend configured with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;apiKey&#34;</span><span class="p">:</span> <span class="s2">&#34;${OPENAI_API_KEY}&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>…will resolve to the actual API key if you&rsquo;ve created a secret with key <code>OPENAI_API_KEY</code>.</p>
<h3 id="the-expansion-pipeline">The expansion pipeline</h3>
<p>On startup, Magec processes secrets before anything else:</p>
<ol>
<li>Load <code>store.json</code> from disk (raw, unexpanded)</li>
<li>Decrypt any encrypted secret values (if <code>encryptionKey</code> is set)</li>
<li>Inject all secret key-value pairs into the process environment via <code>os.Setenv()</code></li>
<li>Expand all <code>${VAR}</code> references across the entire store using <code>os.ExpandEnv()</code></li>
<li>Continue with the fully resolved configuration</li>
</ol>
<p>This two-pass approach means secrets can reference other environment variables, and the rest of the store can reference secrets — everything resolves in a single consistent pass.</p>
<h2 id="encryption-at-rest">Encryption at rest</h2>
<p>When <code>server.encryptionKey</code> is set in <code>config.yaml</code>, secret values are encrypted before writing to <code>store.json</code>:</p>
<table>
  <thead>
      <tr>
          <th>Aspect</th>
          <th>Detail</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Algorithm</strong></td>
          <td>AES-256-GCM (authenticated encryption)</td>
      </tr>
      <tr>
          <td><strong>Key derivation</strong></td>
          <td>PBKDF2 with 100,000 iterations, SHA-256</td>
      </tr>
      <tr>
          <td><strong>Source key</strong></td>
          <td>The <code>encryptionKey</code> from <code>config.yaml</code></td>
      </tr>
      <tr>
          <td><strong>Format</strong></td>
          <td>Encrypted values are stored as <code>enc:v1:&lt;base64&gt;</code> — clearly distinguishable from plain text</td>
      </tr>
  </tbody>
</table>
<p>Without an encryption key, secrets are stored as plain text in <code>store.json</code> and a warning is logged:</p>
<pre tabindex="0"><code>WARN  Secrets are stored without encryption — set server.encryptionKey in config
</code></pre><h2 id="compatibility-with-external-environment-variables">Compatibility with external environment variables</h2>
<p>Secrets don&rsquo;t replace environment variables — they complement them. The expansion pipeline merges both sources:</p>
<ul>
<li><strong>Secrets</strong> are injected via <code>os.Setenv()</code> before expansion</li>
<li><strong>External env vars</strong> (from Docker, Kubernetes, systemd, shell) are already in the environment</li>
<li><code>os.ExpandEnv()</code> resolves all <code>${VAR}</code> references from the combined environment</li>
</ul>
<p>This means you can use both approaches interchangeably:</p>
<table>
  <thead>
      <tr>
          <th>Source</th>
          <th>How to set</th>
          <th>Available as <code>${VAR}</code></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Magec secret</td>
          <td>Admin UI → Secrets</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>Docker env</td>
          <td><code>docker run -e KEY=value</code></td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>Docker Compose env</td>
          <td><code>environment:</code> in <code>compose.yaml</code></td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>Kubernetes env</td>
          <td><code>env:</code> in Pod spec</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>Kubernetes secret</td>
          <td><code>secretKeyRef</code> in Pod spec</td>
          <td>Yes</td>
      </tr>
      <tr>
          <td>Shell export</td>
          <td><code>export KEY=value</code></td>
          <td>Yes</td>
      </tr>
  </tbody>
</table>
<p>If a secret and an external env var have the same key, the <strong>secret takes precedence</strong> — <code>os.Setenv()</code> overwrites the existing value.</p>



<div class="docs-callout docs-callout--info">
  The main advantage of Magec secrets over external environment variables is that you can manage them through the Admin UI without restarting the server or redeploying. Add an API key, and it&rsquo;s available immediately on the next store reload.
</div>

<h2 id="recovery">Recovery</h2>
<h3 id="changing-the-encryption-key">Changing the encryption key</h3>
<p>If you change the encryption key, existing encrypted secrets cannot be decrypted — the derived key will be different. Before changing it:</p>
<ol>
<li>Note down all secret values (they&rsquo;re write-only, so you&rsquo;ll need them from their original source)</li>
<li>Change <code>encryptionKey</code> in <code>config.yaml</code></li>
<li>Restart Magec — encrypted values will fail to decrypt and remain as <code>enc:v1:...</code> strings</li>
<li>Re-create or update each secret with its plain-text value — they&rsquo;ll be re-encrypted with the new key</li>
</ol>
<h3 id="losing-the-encryption-key">Losing the encryption key</h3>
<p>If you lose the encryption key entirely, the same applies — encrypted values are unrecoverable without the original key. You&rsquo;ll need to re-enter all secret values from their original sources.</p>
<h3 id="removing-the-encryption-key">Removing the encryption key</h3>
<p>If you remove <code>encryptionKey</code> from <code>config.yaml</code>:</p>
<ol>
<li>Existing encrypted secrets cannot be decrypted — you&rsquo;ll need to re-create them (they&rsquo;ll be stored as plain text)</li>
<li>New secrets will be stored without encryption and a warning will be logged</li>
</ol>



<div class="docs-callout docs-callout--info">
  The <code>encryptionKey</code> is independent from <code>adminPassword</code>. You can have admin authentication without encryption, or encryption without authentication — though using both together is recommended for production.
</div>


    </div>
  </div>
</div>

  </main>
  <div id="lightbox" class="lightbox">
  <button class="lightbox__close" aria-label="Close">✕</button>
  <img id="lightbox-img" src="" alt="">
</div>

  <footer class="footer">
  <div class="container">
    <div class="footer__inner">
      <div class="footer__brand">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg" width="20" height="20">
          <defs><linearGradient id="fg" x1="0%" y1="100%" x2="100%" y2="0%"><stop offset="0%" stop-color="#f59e0b"/><stop offset="100%" stop-color="#f87171"/></linearGradient></defs>
          <circle cx="32" cy="32" r="26" fill="url(#fg)"/>
          <circle cx="20" cy="24" r="2" fill="white" opacity=".9"/><circle cx="40" cy="22" r="1.8" fill="white" opacity=".8"/>
          <circle cx="38" cy="38" r="2" fill="white" opacity=".75"/>
        </svg>
        Magec · Apache 2.0
      </div>
      <ul class="footer__links">
        <li><a href="https://github.com/achetronic/magec" target="_blank" rel="noopener">GitHub</a></li>
        <li><a href="/docs/">Docs</a></li>
        <li><a href="https://github.com/achetronic/magec/issues" target="_blank" rel="noopener">Issues</a></li>
      </ul>
    </div>
  </div>
</footer>

  <script type="module" src="/js/main.js"></script>
</body>
</html>
